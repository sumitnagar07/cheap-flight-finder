import requests

class FlightSearch:
    """
    This class is responsible for finding the cheapest flights
    using the Kiwi Tequila API.
    """
    def __init__(self, api_key):
        self.kiwi_api_endpoint = "https://api.tequila.kiwi.com/v2/search/flights"
        self.headers = {
            "apikey": api_key
        }

    def get_cheapest_flight(self, destination_iata, date_from, date_to, fly_from_iata="LON"):
        """
        Finds the cheapest flight from a given origin to a destination.
        """
        params = {
            "fly_from": fly_from_iata,
            "fly_to": destination_iata,
            "date_from": date_from,
            "date_to": date_to,
            "one_for_city": 1,
            "nights_in_dst_from": 7,
            "nights_in_dst_to": 28,
            "max_stopovers": 0,
            "limit": 1
        }
        
        try:
            response = requests.get(url=self.kiwi_api_endpoint, headers=self.headers, params=params)
            response.raise_for_status()
            data = response.json()["data"][0]
            
            flight_data = {
                "price": data["price"],
                "origin_city": data["cityFrom"],
                "origin_airport": data["flyFrom"],
                "destination_city": data["cityTo"],
                "destination_airport": data["flyTo"],
                "out_date": data["route"][0]["local_departure"].split("T")[0],
                "return_date": data["route"][1]["local_departure"].split("T")[0]
            }
            return flight_data
        except (requests.exceptions.RequestException, IndexError, KeyError) as e:
            print(f"No flights found for {destination_iata} or an error occurred: {e}")
            return None
